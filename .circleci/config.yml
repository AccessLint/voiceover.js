version: 2.1

orbs:
  macos: circleci/macos@2.0.1

jobs:
  run-voiceover:
    macos:
      xcode: 12.5.1
    resource_class: medium
    steps:
      - checkout
      - macos/add-uitest-permissions
      - macos/add-safari-permissions
      - run:
          name: Add VoiceOver AppleScript DB entry
          command: sudo bash -c 'echo -n "a" > /private/var/db/Accessibility/.VoiceOverAppleScriptEnabled'
      - run:
          name: Set AppleScript enabled default
          command: defaults write com.apple.VoiceOver4/default SCREnableAppleScript -bool true
      - run:
          name: Install dependencies
          command: yarn
      - run:
          name: Start Appium / iOS Simulator
          command: yarn appium
          background: true
      - run:
          name: VoiceOver Test
          command: yarn ts-node examples/ios/index.ts
      - store_artifacts:
          path: "./voiceover"

workflows:
  version: 2
  voiceover-ios:
    jobs:
      - run-voiceover
